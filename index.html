<!DOCTYPE html>
<html>
<head>
    <title>My Love for Drinks</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; }
        #sidebar {
            width: 250px; height: 100vh; background: #fdfbf7;
            border-right: 1px solid #d7ccc8; overflow-y: auto; padding: 20px; box-sizing: border-box; z-index: 1001;
        }
        #map { height: 100vh; flex-grow: 1; background: #aad3df; }
        
        .header-container {
            position: absolute; top: 10px; left: 55%; transform: translateX(-50%); z-index: 1000;
            background: rgba(255, 255, 255, 0.95); padding: 10px 25px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center;
        }

        .zoom-btn {
            display: block; width: 100%; padding: 10px; margin: 8px 0;
            background: #fff; border: 1px solid #d7ccc8; border-radius: 8px;
            text-align: left; cursor: pointer; color: #5d4037; font-weight: bold; font-size: 13px;
        }
        .zoom-btn:hover { background: #efebe9; }

        .tasting-card { padding: 5px; min-width: 200px; text-align: center; }
        .status-badge { font-size: 10px; font-weight: bold; padding: 3px 8px; border-radius: 12px; text-transform: uppercase; }
        .in-stock { background: #2e7d32; color: white; }
        .wishlist { background: #ef6c00; color: white; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2 style="color:#5d4037; font-size:18px;">‚≠ê My Collection</h2>
        <div id="zoom-controls"></div>
    </div>

    <div class="header-container">
        <h1 style="margin:0; font-size:18px;">ü•É My Love for Drinks üç∑</h1>
        <select id="categoryFilter" onchange="filterMarkers()" style="margin-top:5px; padding:3px; border-radius:5px;">
            <option value="All">All Categories</option>
            <option value="Whiskey">Whiskey</option>
            <option value="Gin">Gin</option>
            <option value="Rum">Rum</option>
        </select>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // FIX 1: MaxBounds and worldCopyJump: false prevents the "Data not available" repeat
        var map = L.map('map', { 
            minZoom: 2,
            maxBounds: [[-90, -180], [90, 180]],
            maxBoundsViscosity: 1.0,
            worldCopyJump: false
        }).setView([20, 0], 2);
        
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
            noWrap: true, // Stops the tiles from repeating horizontally
            bounds: [[-90, -180], [90, 180]],
            attribution: 'Tiles &copy; Esri'
        }).addTo(map);

        var spreadsheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSJGK6JrWMMmQ_hsZ-jXvoeDRWZOw0qIghhR5-8gMdU4UfdTImEaO0ogvJw01S8i5QWebwITE9CKaMO/pub?output=csv';
        var allMarkers = [];

        // FIX 2: Bulletproof Pin Color Logic
        function getPinIcon(status) {
            var s = String(status || "").toLowerCase().trim();
            // This will catch "In Stock", "In stock", "in stock ", etc.
            var color = (s.includes("in stock")) ? "green" : "orange";
            
            return new L.Icon({
                iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
        }

        function filterMarkers() {
            var selected = document.getElementById('categoryFilter').value;
            allMarkers.forEach(function(m) {
                if (selected === "All" || m.category === selected) { map.addLayer(m.marker); } 
                else { map.removeLayer(m.marker); }
            });
        }

        Papa.parse(spreadsheetURL, {
            download: true,
            header: true,
            complete: function(results) {
                var controls = document.getElementById('zoom-controls');
                results.data.forEach(function(item) {
                    var lat = parseFloat(item.Lat);
                    var lng = parseFloat(item.Long);

                    if(item.Name && !isNaN(lat) && !isNaN(lng)) {
                        
                        var jLat = lat + (Math.random() - 0.5) * 0.15;
                        var jLng = lng + (Math.random() - 0.5) * 0.15;

                        var statusText = String(item.Status || "Wishlist").trim();
                        var isStock = statusText.toLowerCase().includes("in stock");
                        var statusClass = isStock ? "in-stock" : "wishlist";
                        
                        var popupContent = `
                            <div class="tasting-card">
                                <h3>${item.Name}</h3>
                                <p><strong>${item.Country}</strong></p>
                                <p><span class="status-badge ${statusClass}">${statusText}</span></p>
                                <hr style="border:0; border-top:1px solid #eee;">
                                <p style="font-size:13px; color:#666;">${item.Description}</p>
                            </div>
                        `;

                        var marker = L.marker([jLat, jLng], { icon: getPinIcon(item.Status) })
                                      .bindPopup(popupContent);
                        
                        marker.addTo(map);
                        allMarkers.push({ marker: marker, category: item.Category });

                        var btn = document.createElement('button');
                        btn.className = 'zoom-btn';
                        btn.innerHTML = `üìç ${item.Name}`;
                        btn.onclick = function() {
                            map.flyTo([lat, lng], 6);
                            marker.openPopup();
                        };
                        controls.appendChild(btn);
                    }
                });
            }
        });
    </script>
</body>
</html>
