<!DOCTYPE html>
<html>
<head>
    <title>My Love for Drinks</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 100vh; width: 100%; background: #f4f1ea; }
        
        .header-container {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000;
            background: rgba(255, 255, 255, 0.95); padding: 10px 25px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center; min-width: 300px;
        }
        .header-container h1 { margin: 0; font-size: 20px; color: #5d4037; }
        #categoryFilter { margin-top: 8px; padding: 5px; border-radius: 5px; border: 1px solid #d7ccc8; }

        .tasting-card { padding: 10px; min-width: 200px; text-align: center; }
        .tasting-card img { width: 100%; max-height: 150px; object-fit: contain; border-radius: 5px; margin-bottom: 10px; }
        .tasting-card h2 { margin: 0; font-size: 18px; color: #5d4037; text-transform: uppercase; }
        .status-badge { font-size: 10px; font-weight: bold; padding: 2px 8px; border-radius: 10px; text-transform: uppercase; display: inline-block; margin-bottom: 10px; }
        .in-stock { background: #c8e6c9; color: #2e7d32; }
        .wishlist { background: #ffecb3; color: #ff8f00; }

        .custom-pin { background: none; border: none; }
        .custom-image-pin {
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            background: white;
            object-fit: cover;
            display: block;
        }
    </style>
</head>
<body>

    <div class="header-container">
        <h1>ü•É My Love for Drinks üç∑</h1>
        <select id="categoryFilter" onchange="filterMarkers()">
            <option value="All">All Categories</option>
            <option value="Whiskey">Whiskey</option>
            <option value="Gin">Gin</option>
            <option value="Rum">Rum</option>
        </select>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var map = L.map('map', {
            minZoom: 2, maxBounds: [[-90, -180], [90, 180]], maxBoundsViscosity: 1.0
        }).setView([20, 0], 2);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { noWrap: true }).addTo(map);

        var spreadsheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSJGK6JrWMMmQ_hsZ-jXvoeDRWZOw0qIghhR5-8gMdU4UfdTImEaO0ogvJw01S8i5QWebwITE9CKaMO/pub?output=csv';
        var allMarkers = [];

        function createIcon(item) {
            if (item.ImageURL && item.ImageURL.length > 10) {
                return L.divIcon({
                    className: 'custom-pin',
                    html: `<img src="${item.ImageURL}" class="custom-image-pin" style="width:40px; height:40px;">`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 40],
                    popupAnchor: [0, -40]
                });
            }
            
            var statusStr = String(item.Status).trim().toLowerCase();
            var pinColor = statusStr === "in stock" ? "green" : "orange";
            
            return new L.Icon({
                iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${pinColor}.png`,
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
        }

        function filterMarkers() {
            var selected = document.getElementById('categoryFilter').value;
            allMarkers.forEach(function(m) {
                if (selected === "All" || m.category === selected) { map.addLayer(m.marker); } 
                else { map.removeLayer(m.marker); }
            });
        }

        Papa.parse(spreadsheetURL, {
            download: true, header: true,
            complete: function(results) {
                results.data.forEach(function(item) {
                    var rawLat = parseFloat(item.Lat);
                    var rawLng = parseFloat(item.Long);

                    if(item.Name && !isNaN(rawLat) && !isNaN(rawLng)) {
                        
                        // JITTER FIX: Adds a tiny random offset so overlapping pins are visible
                        var lat = rawLat + (Math.random() - 0.5) * 0.05;
                        var lng = rawLng + (Math.random() - 0.5) * 0.05;

                        var statusStr = String(item.Status).trim();
                        var statusClass = statusStr.toLowerCase() === "in stock" ? "in-stock" : "wishlist";
                        
                        var popupContent = `
                            <div class="tasting-card">
                                ${item.ImageURL ? `<img src="${item.ImageURL}">` : ''}
                                <h2>${item.Name}</h2>
                                <h4>${item.Country}</h4>
                                <span class="status-badge ${statusClass}">${statusStr || 'Unknown'}</span>
                                <p><strong>Category:</strong> ${item.Category}</p>
                                <p>${item.Description}</p>
                            </div>
                        `;

                        var marker = L.marker([lat, lng], {icon: createIcon(item)})
                                      .bindPopup(popupContent);
                        
                        marker.addTo(map);
                        allMarkers.push({ marker: marker, category: item.Category });
                    }
                });
            }
        });
    </script>
</body>
</html>
