Papa.parse('https://docs.google.com/spreadsheets/d/e/2PACX-1vSJGK6JrWMMmQ_hsZ-jXvoeDRWZOw0qIghhR5-8gMdU4UfdTImEaO0ogvJw01S8i5QWebwITE9CKaMO/pub?output=csv', {
    download: true, 
    header: true,
    complete: function(results) {
        console.log("Data loaded:", results.data.length, "rows found."); // DEBUG LINE

        results.data.forEach(function(item) {
            // Validate coordinates exist
            if(!item.Lat || !item.Long || !item.Name) return;

            var rawLat = parseFloat(item.Lat);
            var rawLong = parseFloat(item.Long);

            // INCREASED JITTER: 
            // 0.002 is roughly 200 meters. This makes them visible even at lower zoom.
            var jitterAmount = 0.002; 
            var lat = rawLat + ((Math.random() - 0.5) * jitterAmount);
            var lng = rawLong + ((Math.random() - 0.5) * jitterAmount);

            var rawStatus = String(item.Status || "").trim().toLowerCase();
            var isBar = (rawStatus.startsWith("in") || rawStatus === "mybar") && !rawStatus.includes("not");
            var displayStatus = isBar ? "In My Bar" : "Not in My Bar";
            
            var catInfo = spiritData[item.Category] || { emoji: "üç∑", text: "A premium selection." };
            countries.add(item.Country);

            // Create Marker
            var icon = L.divIcon({ 
                className: `emoji-marker ${isBar ? 'border-in-bar' : 'border-not-in-bar'}`, 
                html: catInfo.emoji, 
                iconSize: [30, 30], 
                iconAnchor: [15, 15], 
                popupAnchor: [0, -10] 
            });

            var popupHtml = `<div class="tasting-card">
                <h2>${item.Name}</h2>
                <div class="sub-header">${catInfo.emoji} ${item.Category}</div>
                <div class="status-badge ${isBar ? 'in-my-bar' : 'not-in-bar'}">${displayStatus}</div>
                <p>${item.Description || ''}</p>
            </div>`;
            
            var marker = L.marker([lat, lng], { icon: icon }).bindPopup(popupHtml);
            
            function selectItem() {
                map.flyTo([lat, lng], 8, { duration: 1.2 }); // Increased zoom level for precision
                setTimeout(() => marker.openPopup(), 1300);
            }

            marker.on('click', selectItem);
            
            var btn = document.createElement('button');
            btn.className = `zoom-btn ${isBar ? 'list-in-bar' : 'list-not-in-bar'}`;
            btn.innerHTML = `${item.Name} <span class="btn-sub">${item.Country}</span>`;
            btn.onclick = (e) => { e.stopPropagation(); closeSidebarOnly(); selectItem(); };

            allData.push({ 
                marker: marker, 
                button: btn, 
                category: item.Category, 
                country: item.Country, 
                name: item.Name, 
                statusFull: displayStatus 
            });
        });

        // Populate Country Dropdown
        var cDrop = document.getElementById('countryFilter');
        Array.from(countries).sort().forEach(c => { 
            var o = document.createElement('option'); 
            o.value = c; o.innerHTML = c; 
            cDrop.appendChild(o); 
        });

        filterAll();
    }
});
